<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prusa Core One Monitor</title>
    
    <style>
        /* ========================================
           GLOBAL STYLES
           ======================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0f0f0f;
            color: #e0e0e0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* ========================================
           TEMPERATURE CARDS
           Display current and target temps for each component
           ======================================== */
        .temp-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .temp-card {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .temp-card:hover {
            border-color: #3a3a3a;
            transform: translateY(-2px);
        }

        .temp-label {
            font-size: 0.85rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .temp-value {
            font-size: 2rem;
            font-weight: 300;
            margin-bottom: 5px;
        }

        /* Target temperature - color changes based on heating state */
        .temp-target {
            font-size: 0.9rem;
            color: #666;
            transition: color 0.3s ease;
        }

        /* Red when heating (not yet at target) */
        .temp-target.heating {
            color: #f44336;
        }

        /* Green when at target temperature */
        .temp-target.at-temp {
            color: #4CAF50;
        }

        /* Color indicator dot next to each temperature label */
        .temp-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        /* ========================================
           TEMPERATURE GRAPH
           Real-time chart showing temp history
           ======================================== */
        .graph-container {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            height: 400px;
        }

        canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* ========================================
           STATUS BANNERS
           Shows print progress and heater power
           ======================================== */
        .status-banner {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-left: 4px solid #4CAF50;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Pulsing status indicator */
        .status-icon {
            width: 10px;
            height: 10px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ========================================
           CONSOLE AND COMMAND SECTIONS
           Two-column layout for log viewing and command input
           ======================================== */
        .bottom-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .log-container,
        .command-container {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 20px;
        }

        .section-title {
            font-size: 0.85rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Scrollable log display with monospace font */
        .log-box {
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            height: 250px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #b0b0b0;
            line-height: 1.8;
        }

        /* Custom scrollbar styling */
        .log-box::-webkit-scrollbar {
            width: 8px;
        }

        .log-box::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        .log-box::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        .log-entry {
            margin-bottom: 8px;
        }

        .log-timestamp {
            color: #888;
            margin-right: 8px;
        }

        /* ========================================
           INPUT AND BUTTONS
           ======================================== */
        .command-input-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
        }

        /* Multi-line textarea for G-code commands */
        textarea {
            flex: 1;
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 12px 15px;
            color: #e0e0e0;
            font-size: 0.95rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            resize: vertical;
            min-height: 60px;
        }

        textarea::placeholder {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }

        button {
            background: #4CAF50;
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        /* Checkbox for filtering temp lines */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: #888;
        }

        .checkbox-container input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* ========================================
           VERSION LABEL
           Shows which HTML version is loaded
           ======================================== */
        .version-label {
            position: fixed;
            bottom: 5px;
            right: 10px;
            font-size: 0.7rem;
            color: #444;
            font-family: monospace;
        }

        /* ========================================
           RESPONSIVE DESIGN
           Stack layout on mobile devices
           ======================================== */
        @media (max-width: 768px) {
            .bottom-section {
                grid-template-columns: 1fr;
            }

            .temp-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Dropdown next to SEND COMMAND */
        .dropdown {
            position: relative;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .dropdown-toggle {
            font-size: 0.85rem;
            /*padding: 4px 10px;*/
            color: #888;
            transition: color 0.2s ease;
            user-select: none;
        }
        
        .dropdown-toggle:hover {
            color: #ccc;
        }
        
        .dropdown-menu {
            position: absolute;
            top: 28px;
            right: 0;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            min-width: 150px;
            display: none;
            flex-direction: column;
            z-index: 1000;
        }
        
        .dropdown-item {
            padding: 10px 15px;
            color: #ddd;
            font-size: 0.9rem;
            border-bottom: 1px solid #222;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item:hover {
            background: #2a2a2a;
        }

        
    </style>
</head>

<body>
    <div class="container">
        <!-- ========================================
             TEMPERATURE CARDS
             Display current readings for all sensors
             ======================================== -->
        <div class="temp-cards">
            <!-- Nozzle Temperature -->
            <div class="temp-card">
                <div class="temp-label">
                    <span class="temp-indicator" style="background: #FF6B6B;"></span>Nozzle
                </div>
                <div class="temp-value">
                    <span id="nozzle-temp">0</span>°C
                </div>
                <div class="temp-target">Target: <span id="nozzle-target">0</span>°C</div>
            </div>

            <!-- Bed Temperature -->
            <div class="temp-card">
                <div class="temp-label">
                    <span class="temp-indicator" style="background: #4ECDC4;"></span>Bed
                </div>
                <div class="temp-value">
                    <span id="bed-temp">0</span>°C
                </div>
                <div class="temp-target">Target: <span id="bed-target">0</span>°C</div>
            </div>

            <!-- Chamber Temperature -->
            <div class="temp-card">
                <div class="temp-label">
                    <span class="temp-indicator" style="background: #FFE66D;"></span>Chamber
                </div>
                <div class="temp-value">
                    <span id="chamber-temp">0</span>°C
                </div>
                <div class="temp-target">Target: <span id="chamber-target">--</span>°C</div>
            </div>

            <!-- Heatbreak Temperature -->
            <div class="temp-card">
                <div class="temp-label">
                    <span class="temp-indicator" style="background: #95E1D3;"></span>Heatbreak
                </div>
                <div class="temp-value">
                    <span id="heatbreak-temp">0</span>°C
                </div>
                <div class="temp-target">Target: <span id="heatbreak-target">--</span>°C</div>
            </div>
        </div>

        <!-- ========================================
             TEMPERATURE GRAPH
             Real-time chart with all temps overlaid
             ======================================== -->
        <div class="graph-container">
            <canvas id="tempChart"></canvas>
        </div>

        <!-- ========================================
             STATUS BANNERS
             Print progress and heater power levels
             ======================================== -->
        <!-- Print Progress Banner -->
        <div class="status-banner">
            <div class="status-icon"></div>
            <span id="status-message">Connecting to printer...</span>
        </div>

        <!-- Heater Power Banner -->
        <div class="status-banner">
            <div class="status-icon" style="background: transparent; animation: none;"></div>
            <span id="power-message">Powers - Nozzle: 0% | Bed: 0% | Heatbreak: 0%</span>
        </div>

        <!-- ========================================
             CONSOLE AND COMMAND SECTIONS
             ======================================== -->
        <div class="bottom-section">
            <!-- Console Log Viewer -->
            <div class="log-container">
                <div class="section-title">
                    <span>Console Log</span>
                    <div class="checkbox-container">
                        <input type="checkbox" id="hide-temps" checked>
                        <label for="hide-temps">Hide Temp Lines</label>
                    </div>
                </div>
                <div class="log-box" id="log-box"></div>
                <div class="command-input-group">
                    <button onclick="clearLog()">Clear</button>
                </div>
            </div>

            <!-- Command Input -->
            <div class="command-container">
                <div class="section-title">
                    <span>Send Command</span>
                
                    <!-- Dropdown -->
                    <!-- Dropdown next to SEND COMMAND -->
                    <div class="dropdown">
                        <div class="dropdown-toggle">⋮</div>
                        <div class="dropdown-menu">
                            <!-- Items will be inserted here dynamically from gcodeMap -->
                        </div>
                    </div>
                </div>              
                <div class="log-box" id="command-history"></div>
                <div class="command-input-group">
                    <textarea id="command-input" 
                              placeholder="Enter G-code commands (one per line)..." 
                              rows="3"></textarea>
                    <button onclick="sendCommand()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart.js library for temperature graphing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <script>
        // ========================================
        // TEMPERATURE CHART INITIALIZATION
        // ========================================
        const ctx = document.getElementById('tempChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],  // Time labels
                datasets: [
                    {
                        label: 'Nozzle',
                        data: [],
                        borderColor: '#FF6B6B',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 0
                    },
                    {
                        label: 'Bed',
                        data: [],
                        borderColor: '#4ECDC4',
                        backgroundColor: 'rgba(78, 205, 196, 0.1)',
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 0
                    },
                    {
                        label: 'Chamber',
                        data: [],
                        borderColor: '#FFE66D',
                        backgroundColor: 'rgba(255, 230, 109, 0.1)',
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 0
                    },
                    {
                        label: 'Heatbreak',
                        data: [],
                        borderColor: '#95E1D3',
                        backgroundColor: 'rgba(149, 225, 211, 0.1)',
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: '#888',
                            usePointStyle: true,
                            padding: 20,
                            font: { size: 11 }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: '#333',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        display: true,
                        grid: {
                            color: '#222',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#666',
                            maxTicksLimit: 10,
                            autoSkip: true,
                            maxRotation: 45,
                            minRotation: 0
                        }
                    },
                    y: {
                        display: true,
                        grid: {
                            color: '#444',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#666',
                            callback: function (value) {
                                return value + '°C';
                            }
                        },
                        suggestedMin: 0,
                        suggestedMax: 250
                    }
                }
            }
        });

        // ========================================
        // GLOBAL STATE
        // ========================================
        
        // Temperature history storage (keeps all data points for infinite scrolling graph)
        let tempHistory = { 
            timestamps: [], 
            nozzle: [], 
            bed: [], 
            chamber: [], 
            heatbreak: [] 
        };

        // Command history for up/down arrow navigation
        let commandHistory = [];
        let commandHistoryIndex = -1;

        // Track if user is manually scrolling (prevents auto-scroll)
        let userScrolling = false;

        // Track how much of the log we've already displayed
        let lastLogLen = 0;

        // ========================================
        // TEMPERATURE COLOR CODING
        // Updates target temp color based on heating state
        // ========================================
        function updateTempColor(elementId, current, target) {
            const element = document.getElementById(elementId).parentElement;

            // Special handling for heatbreak - we DON'T want to reach target
            // Target is a maximum threshold, not a goal
            if (elementId === 'heatbreak-target') {
                if (target > 0) {
                    if (current >= target) {
                        // Exceeded target - RED (danger)
                        element.classList.remove('heating', 'at-temp');
                        element.classList.add('heating');
                    } else if (current >= target * 0.95) {
                        // Within 5% of target - AMBER (warning)
                        element.classList.remove('heating', 'at-temp');
                        element.style.color = '#FFA500';
                        return;
                    } else {
                        // Normal - keep default color
                        element.classList.remove('heating', 'at-temp');
                        element.style.color = '';
                    }
                } else {
                    element.classList.remove('heating', 'at-temp');
                    element.style.color = '';
                }
                return;
            }

            // Normal handling for nozzle and bed
            // Green when at target, red when heating
            if (target > 0) {
                const diff = Math.abs(current - target);
                const tolerance = target * 0.05;  // 5% tolerance
                
                if (diff <= tolerance) {
                    element.classList.remove('heating');
                    element.classList.add('at-temp');
                } else {
                    element.classList.remove('at-temp');
                    element.classList.add('heating');
                }
            } else {
                // No target set - remove all color coding
                element.classList.remove('heating', 'at-temp');
            }
        }

        // ========================================
        // DATA UPDATE FUNCTIONS
        // These poll the ESP32 for new data
        // ========================================

        /**
         * Update Temperature Data
         * Fetches temps from /temps endpoint and updates display + graph
         */
        async function updateTemps() {
            try {
                const resp = await fetch('/temps');
                const data = await resp.json();

                // Update nozzle display
                document.getElementById('nozzle-temp').textContent = data.nozzle.cur;
                document.getElementById('nozzle-target').textContent = data.nozzle.target;
                updateTempColor('nozzle-target', data.nozzle.cur, data.nozzle.target);

                // Update bed display
                document.getElementById('bed-temp').textContent = data.bed.cur;
                document.getElementById('bed-target').textContent = data.bed.target;
                updateTempColor('bed-target', data.bed.cur, data.bed.target);

                // Update chamber display (no target)
                document.getElementById('chamber-temp').textContent = data.chamber.cur;

                // Update heatbreak display
                document.getElementById('heatbreak-temp').textContent = data.heatbreak.cur;
                document.getElementById('heatbreak-target').textContent = data.heatbreak.target;
                updateTempColor('heatbreak-target', data.heatbreak.cur, data.heatbreak.target);

                // Add new data point to graph
                const timeLabel = new Date().toLocaleTimeString();
                tempHistory.timestamps.push(timeLabel);
                tempHistory.nozzle.push(data.nozzle.cur);
                tempHistory.bed.push(data.bed.cur);
                tempHistory.chamber.push(data.chamber.cur);
                tempHistory.heatbreak.push(data.heatbreak.cur);

                // Update chart with new data (keeps all history)
                chart.data.labels = tempHistory.timestamps;
                chart.data.datasets[0].data = tempHistory.nozzle;
                chart.data.datasets[1].data = tempHistory.bed;
                chart.data.datasets[2].data = tempHistory.chamber;
                chart.data.datasets[3].data = tempHistory.heatbreak;
                chart.update('none');

                // Update progress status
                let statusText = 'Progress: ' + data.progress + '% | Time Remaining: ';

                // Format time remaining (hours + minutes if >= 60 mins)
                if (data.time >= 60) {
                    const hours = Math.floor(data.time / 60);
                    const mins = data.time % 60;
                    statusText += hours + ' hr ' + mins + ' min';
                } else {
                    statusText += data.time + ' min';
                }

                // Add filament change time if applicable
                if (data.change !== 'NA' && data.change !== null && data.change !== undefined) {
                    if (data.change >= 60) {
                        const hours = Math.floor(data.change / 60);
                        const mins = data.change % 60;
                        statusText += ' | Change in: ' + hours + ' hr ' + mins + ' min';
                    } else {
                        statusText += ' | Change in: ' + data.change + ' min';
                    }
                }
                document.getElementById('status-message').textContent = statusText;

                // Update heater power display
                const powerText = 'Powers - Nozzle: ' + (data.nozzle_power * 100 / 255).toFixed(0) + 
                                '% | Bed: ' + (data.bed_power * 100 / 255).toFixed(0) + 
                                '% | Heatbreak: ' + (data.heatbreak_power * 100 / 255).toFixed(0) + '%';
                document.getElementById('power-message').textContent = powerText;
            } catch (e) {
                console.error('Failed to update temps:', e);
            }
        }

        /**
         * Update Connection Status
         * Checks if printer is connected and updates status indicator
         */
        async function updateStatus() {
            try {
                const resp = await fetch('/status');
                const text = await resp.text();
                const connected = text.trim() === '1';

                const statusIcon = document.querySelector('.status-icon');
                const statusBanner = document.querySelector('.status-banner');

                if (connected) {
                    statusIcon.style.background = '#4CAF50';
                    statusBanner.style.borderLeftColor = '#4CAF50';
                } else {
                    statusIcon.style.background = '#f44336';
                    statusBanner.style.borderLeftColor = '#f44336';
                    document.getElementById('status-message').textContent = 'Printer Disconnected';
                }
            } catch (e) {
                console.error('Failed to update status:', e);
            }
        }

        /**
         * Update Console Log
         * Fetches new log data and appends to display
         */
        async function updateLog() {
            try {
                const resp = await fetch('/log');
                const text = await resp.text();
                const newText = text.substring(lastLogLen);

                if (newText) {
                    const logBox = document.getElementById('log-box');
                    const hideTemps = document.getElementById('hide-temps').checked;
                    const wasAtBottom = logBox.scrollHeight - logBox.scrollTop <= logBox.clientHeight + 50;

                    // Process each line
                    newText.split(/\r?\n/).forEach(line => {
                        const trimmed = line.trim();
                        if (trimmed) {
                            // Check if this is a temperature line (and if we should hide it)
                            const isTemp = trimmed.startsWith('T:') && 
                                         trimmed.includes(' B:') && 
                                         trimmed.includes(' @:') && 
                                         trimmed.includes(' B@:');
                            
                            if (!hideTemps || !isTemp) {
                                const timestamp = new Date().toLocaleTimeString();
                                const entry = document.createElement('div');
                                entry.className = 'log-entry';
                                entry.innerHTML = '<span class="log-timestamp">' + timestamp + 
                                                '</span><span>' + trimmed + '</span>';
                                logBox.appendChild(entry);
                            }
                        }
                    });

                    // Auto-scroll to bottom only if user was already at bottom
                    if (wasAtBottom && !userScrolling) {
                        logBox.scrollTop = logBox.scrollHeight;
                    }
                }
                lastLogLen = text.length;
            } catch (e) {
                console.error('Failed to update log:', e);
            }
        }

        // ========================================
        // USER INTERACTION FUNCTIONS
        // ========================================

        /**
         * Clear Console Log
         * Clears the log display and resets the server-side buffer
         */
        function clearLog() {
            document.getElementById('log-box').innerHTML = '';
            lastLogLen = 0;
            userScrolling = false;
            fetch('/clear').catch(err => console.error('Failed to clear log:', err));
        }

        /**
         * Send G-code Command(s)
         * Sends one or more G-code commands to the printer
         */
        function sendCommand() {
            const input = document.getElementById('command-input');
            const commands = input.value.trim().split('\n');

            commands.forEach(command => {
                const cmd = command.trim();
                if (cmd) {
                    // Add to command history
                    commandHistory.push(cmd);
                    
                    // Display in command history box
                    const history = document.getElementById('command-history');
                    const timestamp = new Date().toLocaleTimeString();
                    const entry = document.createElement('div');
                    entry.className = 'log-entry';
                    entry.innerHTML = '<span class="log-timestamp">' + timestamp + 
                                    '</span><span>> ' + cmd + '</span>';
                    history.appendChild(entry);
                    history.scrollTop = history.scrollHeight;

                    // Send to ESP32
                    fetch('/send?cmd=' + encodeURIComponent(cmd))
                        .catch(err => console.error('Failed to send command:', err));
                }
            });

            commandHistoryIndex = -1;
            input.value = '';
        }

        // ========================================
        // EVENT LISTENERS
        // ========================================

        
        // Dropdown section
        document.addEventListener('click', (e) => {
            const menu = document.querySelector('.dropdown-menu');
            const toggle = document.querySelector('.dropdown-toggle');
        
            if (toggle.contains(e.target)) {
                // Toggle open/close
                menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
            } else {
                // Close if clicking outside
                menu.style.display = 'none';
            }
        });


        // Map dropdown text to actual G-code commands
        const gcodeMap = {
            'Preheat PLA': ['M104 S170', 'M140 S60'],
            'Preheat PETG': ['M104 S170', 'M140 S85'],
            'Cooldown': ['M104 S0', 'M140 S0'],
            'Unload Filament': ['M702']
        };

        // Get the dropdown menu container
        const dropdownMenu = document.querySelector('.dropdown-menu');

        // Clear existing items (optional if your HTML has placeholder items)
        dropdownMenu.innerHTML = '';

        // Loop through gcodeMap and create items
        Object.keys(gcodeMap).forEach(label => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.textContent = label;
            
            // Attach click listener
            item.addEventListener('click', () => {
                const commands = gcodeMap[label];
                if (!commands) return;

                const history = document.getElementById('command-history');

                commands.forEach(cmd => {
                    if (cmd.trim()) {
                        // Add to command history
                        commandHistory.push(cmd);

                        // Display in command history box
                        const timestamp = new Date().toLocaleTimeString();
                        const entry = document.createElement('div');
                        entry.className = 'log-entry';
                        entry.innerHTML = '<span class="log-timestamp">' + timestamp + 
                                          '</span><span>> ' + cmd + '</span>';
                        history.appendChild(entry);
                        history.scrollTop = history.scrollHeight;

                        // Send to ESP32
                        fetch('/send?cmd=' + encodeURIComponent(cmd))
                            .catch(err => console.error('Failed to send command:', err));
                    }
                });

                // Close dropdown menu
                dropdownMenu.style.display = 'none';
            });

            // Add item to the dropdown menu
            dropdownMenu.appendChild(item);
        });
        
        // Track user scrolling in log box
        const logBox = document.getElementById('log-box');
        logBox.addEventListener('scroll', () => {
            const isAtBottom = logBox.scrollHeight - logBox.scrollTop <= logBox.clientHeight + 50;
            userScrolling = !isAtBottom;
        });
        logBox.addEventListener('wheel', () => {
            userScrolling = true;
        });

        // Command input keyboard handling
        document.getElementById('command-input').addEventListener('keydown', e => {
            // Enter (without Shift) - Send command
            if (e.key === 'Enter' && !e.shiftKey) {
                sendCommand();
                e.preventDefault();
            } 
            // Up Arrow - Previous command in history
            else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (commandHistory.length > 0) {
                    if (commandHistoryIndex === -1) {
                        commandHistoryIndex = commandHistory.length - 1;
                    } else if (commandHistoryIndex > 0) {
                        commandHistoryIndex--;
                    }
                    document.getElementById('command-input').value = commandHistory[commandHistoryIndex];
                }
            } 
            // Down Arrow - Next command in history
            else if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (commandHistoryIndex !== -1) {
                    commandHistoryIndex++;
                    if (commandHistoryIndex >= commandHistory.length) {
                        commandHistoryIndex = -1;
                        document.getElementById('command-input').value = '';
                    } else {
                        document.getElementById('command-input').value = commandHistory[commandHistoryIndex];
                    }
                }
            }
        });

        // ========================================
        // START POLLING
        // ========================================
        setInterval(updateStatus, 1000);   // Check connection every 1 second
        setInterval(updateTemps, 1000);    // Update temps every 1 second
        setInterval(updateLog, 500);       // Update log every 500ms

        // Initial updates
        updateStatus();
        updateTemps();
        updateLog();
    </script>

    <!-- Version Label - Easy to find and edit at bottom of file -->
    <div class="version-label">v0.0.4-remote</div>
</body>

</html>
